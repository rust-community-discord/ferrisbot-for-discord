---
apiVersion: v1
kind: ConfigMap
metadata:
  name: litestream
  namespace: ferrisbot
data:
  litestream.yml: |
    dbs:
      - path: /database/ferris.sqlite3
        replica:
          url: s3://ferrisbot-litestream/ferris.sqlite3
          endpoint: https://nbg1.your-objectstorage.com
---
apiVersion: v1
kind: ConfigMap
metadata:
  name: ferrisbot
  namespace: ferrisbot
data:
  ferris.toml: |
    [database]
    disabled = false
    url = "sqlite://database/ferris.sqlite3"

    [log]
    filter = ""
    rotation = "daily"
    dir = "logs"
    prefix = "ferris"
    suffix = "log"
    max_files = 10
  ferris.secrets.toml: |
    [secrets]
    # ID of the Discord guild that the application will run on
    DISCORD_GUILD = ""

    # ID of your Discord bot application
    APPLICATION_ID = ""

    # ID of the Moderator role. Potentially used someday for `?cleanup` command
    MOD_ROLE_ID = ""

    # ID of the Rustacean role. Used for `?rustify` command
    RUSTACEAN_ROLE_ID = ""

    # ID of the channel to send modmail to
    MODMAIL_CHANNEL_ID = ""

    # ID of the channel for audit logging (edit command logs, etc.)
    MODLOG_CHANNEL_ID = ""

    # The duration to wait before refreshing the godbolt targets list
    GODBOLT_UPDATE_DURATION = "1"
---
apiVersion: apps/v1
kind: StatefulSet
metadata:
  name: ferrisbot
  namespace: ferrisbot
spec:
  selector:
    matchLabels:
      app: ferrisbot
  serviceName: ferrisbot
  replicas: 1
  template:
    metadata:
      labels:
        app: ferrisbot
    spec:
      initContainers:
        - name: init-litestream
          image: litestream/litestream:0.5.6
          args:
            [
              "restore",
              "-if-db-not-exists",
              "-if-replica-exists",
              "/database/ferris.sqlite3",
            ]
          volumeMounts:
            - name: ferrisbot-sqlite
              mountPath: /database
            - name: litestream-config
              mountPath: /etc/litestream.yml
              subPath: litestream.yml
          env:
            - name: LITESTREAM_ACCESS_KEY_ID
              valueFrom:
                secretKeyRef:
                  name: backup-store
                  key: access-key
            - name: LITESTREAM_SECRET_ACCESS_KEY
              valueFrom:
                secretKeyRef:
                  name: backup-store
                  key: secret-key
      containers:
        - name: ferrisbot
          image: ghcr.io/rust-community-discord/ferrisbot-for-discord:caf04f8
          volumeMounts:
            - name: ferrisbot-sqlite
              mountPath: /database
            - name: ferrisbot-config
              mountPath: /config
          env:
            - name: FERRIS_SECRETS__DISCORD_TOKEN
              valueFrom:
                secretKeyRef:
                  name: ferrisbot
                  key: discord-token
        - name: litestream
          image: litestream/litestream:0.5.6
          args: ["replicate"]
          volumeMounts:
            - name: ferrisbot-sqlite
              mountPath: /database
            - name: litestream-config
              mountPath: /etc/litestream.yml
              subPath: litestream.yml
          env:
            - name: LITESTREAM_ACCESS_KEY_ID
              valueFrom:
                secretKeyRef:
                  name: backup-store
                  key: access-key
            - name: LITESTREAM_SECRET_ACCESS_KEY
              valueFrom:
                secretKeyRef:
                  name: backup-store
                  key: secret-key
          ports:
            - name: metrics
              containerPort: 9090
      volumes:
        - name: litestream-config
          configMap:
            name: litestream
        - name: ferrisbot-config
          configMap:
            name: ferrisbot
  volumeClaimTemplates:
    - metadata:
        name: ferrisbot-sqlite
      spec:
        accessModes:
          - ReadWriteOnce
        resources:
          requests:
            storage: 1Gi
        storageClassName: hcloud-volumes
